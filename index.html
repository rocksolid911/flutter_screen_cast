<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Screen Mirror Cast Receiver - App ID: 7D1A32C2</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: monospace;
            overflow: hidden;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        .screen-display {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screen-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .status-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
        }

        .waiting-message {
            text-align: center;
            color: #fff;
            font-size: 24px;
        }

        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <div class="container">
        <div id="screenDisplay" class="screen-display">
            <div class="waiting-message">
                üé¨ Ready for Screen Mirroring<br>
                <small>App ID: 7D1A32C2</small>
            </div>
        </div>

        <div id="statusOverlay" class="status-overlay">
            <div id="status">üîÑ Initializing...</div>
            <div id="stats">Frames: 0 | FPS: 0 | Size: 0 KB</div>
        </div>
    </div>

    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script>
        class ScreenMirrorReceiver {
            constructor() {
                this.statusEl = document.getElementById('status');
                this.statsEl = document.getElementById('stats');
                this.screenDisplayEl = document.getElementById('screenDisplay');
                this.currentImageEl = null;

                // Statistics
                this.frameCount = 0;
                this.lastFpsTime = Date.now();
                this.fpsCounter = 0;
                this.currentFps = 0;
                this.lastMessageSize = 0;

                this.init();

                // Debug - check connection
                console.log('üöÄ ScreenMirrorReceiver initialized - IMPROVED VERSION');
            }

            init() {
                try {
                    console.log('üöÄ Starting Screen Mirror Receiver');
                    this.updateStatus('Initializing receiver...');

                    const options = new cast.framework.CastReceiverOptions();
                    options.disableIdleTimeout = true;
                    options.maxInactivity = 3600; // 1 hour

                    const context = cast.framework.CastReceiverContext.getInstance();

                    // Handle connections
                    context.addEventListener(
                        cast.framework.system.EventType.SENDER_CONNECTED,
                        (event) => {
                            console.log(`üì± Sender connected: ${event.senderId}`);
                            this.updateStatus('‚úÖ Connected - Ready for screen mirroring');
                        }
                    );

                    context.addEventListener(
                        cast.framework.system.EventType.SENDER_DISCONNECTED,
                        (event) => {
                            console.log(`üì± Sender disconnected: ${event.senderId}`);
                            this.updateStatus('‚ùå Sender disconnected');
                            this.clearScreen();
                        }
                    );

                    context.addEventListener(
                        cast.framework.system.EventType.READY,
                        () => {
                            console.log('‚úÖ Cast Receiver ready for screen mirroring');
                            this.updateStatus('üéØ Ready for connections');
                        }
                    );

                    // Listen for screen frame messages
                    context.addCustomMessageListener(
                        'urn:x-cast:com.isvisoft.flutter_screen_recording',
                        (event) => {
                            this.handleMessage(event);
                        }
                    );

                    // Start the receiver
                    context.start(options);

                    // Start stats update interval
                    setInterval(() => this.updateStats(), 1000);

                } catch (error) {
                    console.error(`‚ùå Initialization error: ${error.message}`);
                    this.updateStatus(`‚ùå Failed to initialize: ${error.message}`);
                }
            }

            handleMessage(event) {
                try {
                    const message = JSON.parse(event.data);
                    console.log(`üì® Received message type: ${message.type}`);

                    switch (message.type) {
                        case 'screen_frame':
                            this.handleScreenFrame(message);
                            break;

                        case 'control':
                            this.handleControlMessage(message);
                            break;

                        default:
                            console.warn(`‚ö†Ô∏è Unknown message type: ${message.type}`);
                    }

                } catch (e) {
                    console.error(`‚ùå Error parsing message: ${e.message}`);
                    this.updateStatus(`‚ùå Error: ${e.message}`);
                }
            }

            handleScreenFrame(message) {
                try {
                    if (!message.data) {
                        console.warn('‚ö†Ô∏è Received screen frame without data');
                        return;
                    }

                    this.displayFrame(message.data);
                    this.lastMessageSize = message.data.length;
                    this.frameCount++;
                    this.fpsCounter++;

                } catch (e) {
                    console.error(`‚ùå Error handling screen frame: ${e.message}`);
                    this.updateStatus(`‚ùå Frame error: ${e.message}`);
                }
            }

            displayFrame(base64Data) {
                try {
                    // Create or update image element
                    if (!this.currentImageEl) {
                        console.log('üñºÔ∏è Creating new image element for display');
                        this.currentImageEl = document.createElement('img');
                        this.currentImageEl.className = 'screen-image';
                        this.screenDisplayEl.innerHTML = '';
                        this.screenDisplayEl.appendChild(this.currentImageEl);
                    }

                    // Update image source
                    this.currentImageEl.src = `data:image/jpeg;base64,${base64Data}`;

                    // Add onload and onerror handlers for debugging
                    this.currentImageEl.onload = () => {
                        console.log(`‚úÖ Frame loaded: ${this.currentImageEl.naturalWidth}x${this.currentImageEl.naturalHeight}`);
                        this.updateStatus('üì∫ Screen mirroring active');
                    };

                    this.currentImageEl.onerror = () => {
                        console.error('‚ùå Error loading image');
                        this.updateStatus('‚ùå Error displaying frame');
                    };

                } catch (e) {
                    console.error(`‚ùå Error displaying frame: ${e.message}`);
                }
            }

            handleControlMessage(message) {
                console.log(`üéÆ Control: ${message.action}`);

                switch (message.action) {
                    case 'display_paused':
                        this.updateStatus('‚è∏Ô∏è Display paused');
                        break;
                    case 'display_resumed':
                        this.updateStatus('‚ñ∂Ô∏è Display resumed');
                        break;
                    case 'display_stopped':
                        this.updateStatus('‚èπÔ∏è Display stopped');
                        this.clearScreen();
                        break;
                }
            }

            clearScreen() {
                console.log('üßπ Clearing screen');
                this.screenDisplayEl.innerHTML = `
                    <div class="waiting-message">
                        üé¨ Ready for Screen Mirroring<br>
                        <small>App ID: 7D1A32C2</small>
                    </div>
                `;
                this.currentImageEl = null;
            }

            updateStats() {
                const now = Date.now();
                if (now - this.lastFpsTime >= 1000) {
                    this.currentFps = this.fpsCounter;
                    this.fpsCounter = 0;
                    this.lastFpsTime = now;
                }

                const sizeKb = Math.round(this.lastMessageSize / 1024);
                this.statsEl.textContent =
                    `Frames: ${this.frameCount} | FPS: ${this.currentFps} | Size: ${sizeKb} KB`;
            }

            updateStatus(text) {
                console.log(`üìä Status: ${text}`);
                this.statusEl.textContent = text;
            }
        }

        // Initialize the receiver
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing receiver');
            window.receiver = new ScreenMirrorReceiver();
        });
    </script>
</body>
</html>


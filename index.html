<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Screen Mirror Cast Receiver - App ID: 7D1A32C2</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: monospace;
            overflow: hidden;
        }
        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        .screen-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: 2px solid lime; /* Visual indicator */
        }
        .debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: lime;
            padding: 10px;
            font-size: 12px;
            max-width: 40%;
            z-index: 10;
            border: 1px solid lime;
        }
        .test-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: yellow;
            padding: 10px;
            font-size: 12px;
            max-width: 40%;
            z-index: 10;
            border: 1px solid yellow;
        }
        .raw-data {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: lime;
            padding: 5px;
            font-size: 10px;
            max-height: 100px;
            overflow: auto;
            word-break: break-all;
            border: 1px solid lime;
        }
        .show-raw {
            position: absolute;
            bottom: 120px;
            left: 10px;
            background: #333;
            color: white;
            border: 1px solid lime;
            padding: 5px 10px;
            cursor: pointer;
        }
        .test-buttons {
            position: absolute;
            bottom: 120px;
            right: 10px;
        }
        .test-buttons button {
            background: #333;
            color: yellow;
            border: 1px solid yellow;
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <img id="screen" class="screen-image" />

        <div id="debug" class="debug-panel">
            <div><strong>ðŸŽ¬ CAST RECEIVER DEBUG</strong></div>
            <div>Status: <span id="status">Initializing...</span></div>
            <div>Messages: <span id="messageCount">0</span></div>
            <div>Frames: <span id="frames">0</span></div>
            <div>Data Size: <span id="dataSize">0 bytes</span></div>
            <div>Image Load: <span id="imageStatus">None</span></div>
            <div>Last Error: <span id="error">None</span></div>
            <div>Message Type: <span id="msgType">None</span></div>
        </div>

        <div id="testPanel" class="test-panel">
            <div><strong>ðŸ§ª TEST PANEL</strong></div>
            <div>Image Dimensions: <span id="imageDims">Unknown</span></div>
            <div>Image Source Length: <span id="imageSrcLen">0</span></div>
            <div>Base64 Valid: <span id="base64Valid">Unknown</span></div>
            <div>Last Decode: <span id="lastDecode">Never</span></div>
        </div>

        <div class="test-buttons">
            <button onclick="testImage()">Test Sample Image</button>
            <button onclick="clearImage()">Clear Image</button>
            <button onclick="showImageInfo()">Show Image Info</button>
        </div>

        <button id="showRaw" class="show-raw">Show/Hide Raw Data</button>
        <div id="rawData" class="raw-data" style="display:none;"></div>
    </div>

    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script>
        // Counters and state
        let frameCount = 0;
        let messageCount = 0;
        let errorCount = 0;
        let rawVisible = false;
        let lastImageData = null;

        // Elements
        const screenEl = document.getElementById('screen');
        const statusEl = document.getElementById('status');
        const messageCountEl = document.getElementById('messageCount');
        const framesEl = document.getElementById('frames');
        const dataSizeEl = document.getElementById('dataSize');
        const imageStatusEl = document.getElementById('imageStatus');
        const errorEl = document.getElementById('error');
        const msgTypeEl = document.getElementById('msgType');
        const rawDataEl = document.getElementById('rawData');
        const showRawBtn = document.getElementById('showRaw');
        const imageDemsEl = document.getElementById('imageDims');
        const imageSrcLenEl = document.getElementById('imageSrcLen');
        const base64ValidEl = document.getElementById('base64Valid');
        const lastDecodeEl = document.getElementById('lastDecode');

        // Image event listeners for debugging
        screenEl.onload = function() {
            log('âœ… Image loaded successfully!');
            imageStatusEl.textContent = 'Loaded âœ…';
            imageDemsEl.textContent = `${this.naturalWidth}x${this.naturalHeight}`;
            imageSrcLenEl.textContent = this.src.length;
        };

        screenEl.onerror = function(e) {
            logError('âŒ Image failed to load: ' + e.type);
            imageStatusEl.textContent = 'Failed âŒ';
        };

        screenEl.onabort = function() {
            log('âš ï¸ Image load aborted');
            imageStatusEl.textContent = 'Aborted âš ï¸';
        };

        // Toggle raw data visibility
        showRawBtn.addEventListener('click', () => {
            rawVisible = !rawVisible;
            rawDataEl.style.display = rawVisible ? 'block' : 'none';
        });

        // Test functions
        function testImage() {
            log('ðŸ§ª Testing with sample image...');
            // Small red square test image
            const testBase64 = '/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwA/8A';
            screenEl.src = 'data:image/jpeg;base64,' + testBase64;
            imageStatusEl.textContent = 'Testing...';
        }

        function clearImage() {
            log('ðŸ§¹ Clearing image...');
            screenEl.src = '';
            imageStatusEl.textContent = 'Cleared';
            imageDemsEl.textContent = 'Unknown';
            imageSrcLenEl.textContent = '0';
        }

        function showImageInfo() {
            log('ðŸ“Š Current image info:');
            log(`  - Source length: ${screenEl.src.length}`);
            log(`  - Natural size: ${screenEl.naturalWidth}x${screenEl.naturalHeight}`);
            log(`  - Complete: ${screenEl.complete}`);
            log(`  - Current src: ${screenEl.src.substring(0, 100)}...`);
        }

        // Initialize cast receiver
        function initReceiver() {
            try {
                log('ðŸš€ Starting enhanced Cast receiver with debugging');
                updateStatus('Starting...');

                const options = new cast.framework.CastReceiverOptions();
                options.disableIdleTimeout = true;

                const context = cast.framework.CastReceiverContext.getInstance();

                context.addEventListener(cast.framework.system.EventType.READY, () => {
                    log('âœ… Receiver is ready');
                    updateStatus('Ready');
                });

                context.addEventListener(cast.framework.system.EventType.SENDER_CONNECTED, (e) => {
                    log('ðŸ“± Sender connected: ' + e.senderId);
                    updateStatus('Connected');
                });

                context.addEventListener(cast.framework.system.EventType.SENDER_DISCONNECTED, (e) => {
                    log('ðŸ“± Sender disconnected: ' + e.senderId);
                    updateStatus('Disconnected');
                    clearImage();
                });

                // Listen on the custom namespace
                context.addCustomMessageListener('urn:x-cast:com.isvisoft.flutter_screen_recording', (event) => {
                    handleMessage(event.data);
                });

                context.start(options);
                log('âœ… Receiver initialized successfully');

            } catch (e) {
                logError('âŒ Initialization failed: ' + e.message);
                updateStatus('Init failed');
            }
        }

        // Handle incoming messages
        function handleMessage(data) {
            try {
                messageCount++;
                messageCountEl.textContent = messageCount;

                log(`ðŸ“¨ Message #${messageCount} received`);
                
                // Show raw data
                showRawMessage(data);

                // Get data size
                const dataSize = typeof data === 'string' ? data.length : JSON.stringify(data).length;
                dataSizeEl.textContent = `${dataSize} bytes`;
                log(`ðŸ“ Message size: ${dataSize} bytes`);

                let message;
                if (typeof data === 'string') {
                    try {
                        message = JSON.parse(data);
                        msgTypeEl.textContent = message.type || 'unknown';
                        log(`ðŸ“‹ Message type: ${message.type}`);

                        if (message.type === 'screen_frame' && message.data) {
                            log('ðŸŽ¯ Processing screen_frame message');
                            
                            const imageData = message.data;
                            log(`ðŸ–¼ï¸ Image data length: ${imageData.length}`);
                            
                            // Validate base64
                            const isValidBase64 = validateBase64(imageData);
                            base64ValidEl.textContent = isValidBase64 ? 'Valid âœ…' : 'Invalid âŒ';
                            log(`ðŸ” Base64 valid: ${isValidBase64}`);
                            
                            if (isValidBase64) {
                                displayFrame(imageData);
                            } else {
                                logError('âŒ Invalid base64 data received');
                            }
                        } else {
                            log(`âš ï¸ Unknown/incomplete message: ${JSON.stringify(message).substring(0, 200)}`);
                        }
                    } catch (jsonError) {
                        logError('âŒ JSON parsing error: ' + jsonError.message);
                        log(`ðŸ“„ Raw data preview: ${data.substring(0, 200)}...`);
                        
                        // Try to extract base64 data with regex
                        const dataMatch = data.match(/"data":"([^"]+)"/);
                        if (dataMatch && dataMatch[1]) {
                            log('ðŸŽ¯ Extracted data with regex');
                            const imageData = dataMatch[1];
                            const isValidBase64 = validateBase64(imageData);
                            base64ValidEl.textContent = isValidBase64 ? 'Valid âœ…' : 'Invalid âŒ';
                            
                            if (isValidBase64) {
                                displayFrame(imageData);
                            }
                        }
                    }
                } else {
                    logError('âŒ Received non-string message');
                }
            } catch (e) {
                logError('âŒ Error handling message: ' + e.message);
                console.error('Full error:', e);
            }
        }

        // Validate base64 string
        function validateBase64(str) {
            try {
                return btoa(atob(str)) === str;
            } catch (e) {
                return false;
            }
        }

        // Display the frame on screen
        function displayFrame(base64Data) {
            try {
                log('ðŸŽ¬ Attempting to display frame...');
                
                lastImageData = base64Data;
                lastDecodeEl.textContent = new Date().toLocaleTimeString();
                
                // Set image status to loading
                imageStatusEl.textContent = 'Loading...';
                
                // Create the data URL
                const dataUrl = 'data:image/jpeg;base64,' + base64Data;
                log(`ðŸ”— Data URL length: ${dataUrl.length}`);
                
                // Set the image source
                screenEl.src = dataUrl;

                frameCount++;
                framesEl.textContent = frameCount;
                updateStatus('Streaming');
                
                log(`âœ… Frame #${frameCount} set as image source`);

            } catch (e) {
                logError('âŒ Display error: ' + e.message);
                imageStatusEl.textContent = 'Error âŒ';
            }
        }

        // Show raw message data
        function showRawMessage(data) {
            try {
                let displayData = typeof data === 'string' ? data : JSON.stringify(data);

                if (displayData.length > 400) {
                    displayData = displayData.substring(0, 200) + 
                        '\n... [' + (displayData.length - 400) + ' more chars] ...\n' +
                        displayData.substring(displayData.length - 200);
                }

                rawDataEl.textContent = displayData;
            } catch (e) {
                rawDataEl.textContent = 'Error showing raw data: ' + e.message;
            }
        }

        // Helper functions
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
        }

        function logError(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.error(`[${timestamp}] ${message}`);
            errorCount++;
            errorEl.textContent = message;
        }

        function updateStatus(status) {
            statusEl.textContent = status;
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            log('ðŸŽ¯ DOM loaded, checking Cast framework...');
            
            if (typeof cast !== 'undefined' && cast.framework) {
                log('âœ… Cast framework found');
                initReceiver();
            } else {
                logError('âŒ Cast framework not found');
                updateStatus('Cast SDK missing');
                
                // Retry after a delay
                setTimeout(() => {
                    if (typeof cast !== 'undefined' && cast.framework) {
                        log('âœ… Cast framework loaded on retry');
                        initReceiver();
                    }
                }, 2000);
            }
        });

        // Test with sample image on startup
        setTimeout(() => {
            log('ðŸ§ª Auto-testing with sample image in 3 seconds...');
            testImage();
        }, 3000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Screen Mirror Cast Receiver - App ID: 7D1A32C2</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: monospace;
            overflow: hidden;
        }
        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        .screen-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: lime;
            padding: 10px;
            font-size: 12px;
            max-width: 80%;
            z-index: 10;
        }
        .raw-data {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: lime;
            padding: 5px;
            font-size: 10px;
            max-height: 100px;
            overflow: hidden;
            word-break: break-all;
        }
        .show-raw {
            position: absolute;
            bottom: 120px;
            left: 10px;
            background: #333;
            color: white;
            border: none;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <img id="screen" class="screen-image" />

        <div id="debug" class="debug-panel">
            <div>Status: <span id="status">Initializing...</span></div>
            <div>Frames: <span id="frames">0</span></div>
            <div>Last Error: <span id="error">None</span></div>
            <div>Type: <span id="msgType">None</span></div>
        </div>

        <button id="showRaw" class="show-raw">Show/Hide Raw Data</button>
        <div id="rawData" class="raw-data" style="display:none;"></div>
    </div>

    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script>
        // Simple counter to track frames
        let frameCount = 0;
        let errorCount = 0;
        let rawVisible = false;

        // Elements
        const screenEl = document.getElementById('screen');
        const statusEl = document.getElementById('status');
        const framesEl = document.getElementById('frames');
        const errorEl = document.getElementById('error');
        const msgTypeEl = document.getElementById('msgType');
        const rawDataEl = document.getElementById('rawData');
        const showRawBtn = document.getElementById('showRaw');

        // Toggle raw data visibility
        showRawBtn.addEventListener('click', () => {
            rawVisible = !rawVisible;
            rawDataEl.style.display = rawVisible ? 'block' : 'none';
        });

        // Initialize cast receiver
        function initReceiver() {
            try {
                // Log to both console and UI
                log('Starting minimal Cast receiver');
                updateStatus('Starting...');

                // Simple options
                const options = new cast.framework.CastReceiverOptions();
                options.disableIdleTimeout = true;

                // Get context
                const context = cast.framework.CastReceiverContext.getInstance();

                // Basic event listeners
                context.addEventListener(cast.framework.system.EventType.READY, () => {
                    log('Receiver is ready');
                    updateStatus('Ready');
                });

                context.addEventListener(cast.framework.system.EventType.SENDER_CONNECTED, (e) => {
                    log('Sender connected: ' + e.senderId);
                    updateStatus('Connected');
                });

                context.addEventListener(cast.framework.system.EventType.SENDER_DISCONNECTED, (e) => {
                    log('Sender disconnected: ' + e.senderId);
                    updateStatus('Disconnected');
                    screenEl.src = '';
                });

                // Listen on the custom namespace
                context.addCustomMessageListener('urn:x-cast:com.isvisoft.flutter_screen_recording', (event) => {
                    handleMessage(event.data);
                });

                // Start the receiver
                context.start(options);
                log('Receiver initialized successfully');

            } catch (e) {
                logError('Initialization failed: ' + e.message);
                updateStatus('Init failed');
            }
        }

        // Handle incoming messages
        function handleMessage(data) {
            try {
                // First display the raw data for debugging
                showRawMessage(data);

                // Now try to parse and process it
                let message;
                if (typeof data === 'string') {
                    // Try to parse as JSON
                    try {
                        message = JSON.parse(data);
                        msgTypeEl.textContent = message.type || 'unknown';

                        // Handle both screen_frame and screenframe for compatibility
                        if ((message.type === 'screen_frame' || message.type === 'screenframe') && 
                            (message.data || message.datat)) {
                            
                            // Use either data or datat field
                            const imageData = message.data || message.datat;
                            displayFrame(imageData);
                        } else {
                            log('Unknown message format: ' + JSON.stringify(message));
                        }
                    } catch (jsonError) {
                        logError('JSON parsing error: ' + jsonError.message);

                        // Try multiple regex patterns to extract data
                        const patterns = [
                            /"data":"([^"]+)"/,
                            /"datat":"([^"]+)"/
                        ];
                        
                        for (const pattern of patterns) {
                            const match = data.match(pattern);
                            if (match && match[1]) {
                                log('Extracted data using pattern: ' + pattern);
                                displayFrame(match[1]);
                                break;
                            }
                        }
                    }
                } else {
                    logError('Received non-string message');
                }
            } catch (e) {
                logError('Error handling message: ' + e.message);
            }
        }

        // Display the frame on screen
        function displayFrame(base64Data) {
            try {
                // Set the image source to the base64 data
                screenEl.src = 'data:image/jpeg;base64,' + base64Data;

                // Update counter
                frameCount++;
                framesEl.textContent = frameCount;
                updateStatus('Streaming');

            } catch (e) {
                logError('Display error: ' + e.message);
            }
        }

        // Show raw message data
        function showRawMessage(data) {
            try {
                let displayData = typeof data === 'string' ? data : JSON.stringify(data);

                // Truncate if too long
                if (displayData.length > 200) {
                    displayData = displayData.substring(0, 100) + '...' +
                        displayData.substring(displayData.length - 100);
                }

                rawDataEl.textContent = displayData;
            } catch (e) {
                rawDataEl.textContent = 'Error showing raw data: ' + e.message;
            }
        }

        // Helper functions
        function log(message) {
            console.log('[Receiver] ' + message);
        }

        function logError(message) {
            console.error('[Receiver] ' + message);
            errorCount++;
            errorEl.textContent = message;
        }

        function updateStatus(status) {
            statusEl.textContent = status;
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof cast !== 'undefined' && cast.framework) {
                initReceiver();
            } else {
                logError('Cast framework not found');
                updateStatus('Cast SDK missing');
            }
        });
    </script>
</body>
</html>
